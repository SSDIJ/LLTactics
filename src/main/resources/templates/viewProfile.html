<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LL Tactics</title>

    <!-- Estilos de Bootstrap y Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">

    <!-- Fragmentos de Thymeleaf -->
    <th:block th:replace="~{fragments/head :: header}" />

    <link rel="stylesheet" href="styles.css"> <!-- Archivo CSS propio -->
</head>
<body class="profile-body">
    <header th:replace="~{fragments/nav.html :: nav}"></header>

    <img src="/img/homepage/sword.png" alt="Espada" id="homepage-sword">

    <div class="user">
        <!-- TOP: BARRA DE BÚSQUEDA DE JUGADOR -->
        <div class="top-user">
            <form action="/user/viewProfile" method="GET">
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0">
                        <button type="submit" class="btn btn-light border-0" id="searchBtn2">
                            <i class="fas fa-search text-muted"></i>
                        </button>
                    </span>
                    <input type="text" id="searchPlayer2" name="nombre" class="form-control border-start-0 border-end-0" placeholder="Buscar">
                </div>
            </form>
        </div>
    </div>

    <!-- MENSAJE DE USUARIO NO ENCONTRADO -->
    <div th:if="${usuarioBuscado == null}">
      <p> El usuario no ha sido encontrado o no existe.</p>
    </div>

    <!-- PERFIL DEL USUARIO SI EXISTE -->
    <div class="mid-user text-center" th:if="${usuarioBuscado != null}">
        <h1 class="mt-5"><span th:text="${usuarioBuscado.username}"></span></h1>

        <div class="profile-pic">
            <div th:if="${usuarioBuscadofotoPerfil == null}">
                <a href="#" data-bs-toggle="modal" data-bs-target="#editarFotoModal">
                    <img th:src="@{/img/profile_pics/default_profile.png}" alt="Foto de perfil" class="rounded-circle border border-3 border-dark shadow"/>
                </a>
            </div>
            <div th:unless="${usuarioBuscadofotoPerfil == null}">
                <a href="#" data-bs-toggle="modal" data-bs-target="#editarFotoModal">
                    <img th:src="${usuarioBuscadofotoPerfil}" alt="Foto de perfil" class="rounded-circle border border-3 border-dark shadow"/>
                </a>
            </div>
        </div>

        <!-- ESTADÍSTICAS DEL PERFIL -->
        <div class="bot-user">
            <div class="container mt-5">
                <div class="row d-flex justify-content-between" style="flex-wrap: wrap;">
                    <!-- Puntuación de Maestría -->
                    <div class="card text-center p-3 mb-3" style="flex: 1 1 22%; min-width: 100px;">
                        <div class="card-body">
                            <h5 class="card-title">Puntuación de Maestría</h5>
                            <h3 class="text-primary">410</h3>
                        </div>
                    </div>

                    <!-- Personaje más Jugado -->
                    <div class="card text-center p-3 mb-3" style="flex: 1 1 22%; min-width: 100px;">
                        <div class="card-body">
                            <h5 class="card-title">Personaje más Jugado</h5>
                            <img src="/img/units/humans/3. Caballero/knight.png" alt="Caballero" class="img-fluid rounded-circle">
                        </div>
                    </div>

                    <!-- Facción Favorita -->
                    <div class="card text-center p-3 mb-3" style="flex: 1 1 22%; min-width: 100px;">
                        <div class="card-body">
                            <h5 class="card-title">Facción Favorita</h5>
                            <img src="/img/units/banners/humans.png" class="img-fluid">
                        </div>
                    </div>

                    <!-- GRÁFICA DE VICTORIAS Y DERROTAS -->
                    <div class="card text-center p-3 mb-3" style="flex: 1 1 22%; min-width: 100px;">
                        <div class="card-body">
                            <h5 class="card-title">Ratio de Victorias</h5>
                            <canvas id="winrateChart" width="200" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        console.log("Ganadas:", /*[[${usuarioBuscado.partidasGanadas}]]*/ 0);

        document.addEventListener("DOMContentLoaded", function () {
            const ganadas = /*[[${usuarioBuscado.partidasGanadas}]]*/ 10;
            const perdidas = /*[[${usuarioBuscado.partidasPerdidas}]]*/ 20;

            const canvas = document.getElementById("winrateChart");
            if (!canvas) {
                console.warn("Canvas 'winrateChart' no encontrado");
                return;
            }

            const ctx = canvas.getContext("2d");

            new Chart(ctx, {
                type: "pie",
                data: {
                    labels: ["Victorias", "Derrotas"],
                    datasets: [{
                        label: "Resultados",
                        data: [ganadas, perdidas],
                        backgroundColor: ["#4CAF50", "#F44336"],
                        borderColor: "#222",
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                color: "black",
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || "";
                                    const value = context.raw || 0;
                                    const total = ganadas + perdidas;
                                    const porcentaje = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const previewImg = document.getElementById("preview-img");
            const radioButtons = document.querySelectorAll('input[name="selectedPic"]');

            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    const imgElement = this.nextElementSibling;
                    previewImg.src = imgElement.src;
                });
            });
        });
    </script>

</body>
</html>
